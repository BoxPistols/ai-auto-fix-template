# Reusable AI Auto-Fix Workflow
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»–ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ç”¨ã§ãã¾ã™
#
# ä½¿ç”¨æ–¹æ³•:
# jobs:
#   ai-auto-fix:
#     uses: BoxPistols/ai-auto-fix-template/.github/workflows/reusable-ai-auto-fix.yml@main
#     secrets:
#       GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}      # æŽ¨å¥¨ï¼ˆç„¡æ–™æž ã‚ã‚Šï¼‰
#       ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }} # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

name: Reusable AI Auto-Fix

on:
  workflow_call:
    inputs:
      node_version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
      package_manager:
        description: 'Package manager (pnpm, npm, yarn)'
        required: false
        type: string
        default: 'pnpm'
      pnpm_version:
        description: 'pnpm version (if using pnpm)'
        required: false
        type: string
        default: '9'
      lint_command:
        description: 'Lint command'
        required: false
        type: string
        default: 'lint'
      lint_fix_command:
        description: 'Lint fix command'
        required: false
        type: string
        default: 'lint:fix'
      format_command:
        description: 'Format command'
        required: false
        type: string
        default: 'format'
      type_check_command:
        description: 'Type check command'
        required: false
        type: string
        default: 'type-check'
      build_command:
        description: 'Build command'
        required: false
        type: string
        default: 'build'
      test_command:
        description: 'Test command'
        required: false
        type: string
        default: 'test'
      tech_stack:
        description: 'Technology stack description for AI context'
        required: false
        type: string
        default: 'React, TypeScript, Vite'
      gemini_model:
        description: 'Gemini model to use'
        required: false
        type: string
        default: 'gemini-2.0-flash'
      claude_model:
        description: 'Claude model to use (fallback)'
        required: false
        type: string
        default: 'claude-sonnet-4-20250514'
      language:
        description: 'Language for comments (ja/en)'
        required: false
        type: string
        default: 'ja'
    secrets:
      GOOGLE_API_KEY:
        required: false
        description: 'Google API Key for Gemini (recommended, free tier available)'
      ANTHROPIC_API_KEY:
        required: false
        description: 'Anthropic API Key for Claude (fallback)'
    outputs:
      fixes_applied:
        description: 'Whether fixes were applied'
        value: ${{ jobs.ai-fix.outputs.fixes_applied }}
      issues_detected:
        description: 'Whether issues were detected'
        value: ${{ jobs.detect-issues.outputs.should_run_fix }}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  detect-issues:
    name: å•é¡Œæ¤œå‡º
    runs-on: ubuntu-latest
    outputs:
      has_lint_errors: ${{ steps.detect.outputs.lint_errors }}
      has_format_errors: ${{ steps.detect.outputs.format_errors }}
      has_ts_errors: ${{ steps.detect.outputs.ts_errors }}
      has_build_errors: ${{ steps.detect.outputs.build_errors }}
      has_test_failures: ${{ steps.detect.outputs.test_failures }}
      has_conflicts: ${{ steps.detect.outputs.conflicts }}
      gemini_high_priority: ${{ steps.gemini-check.outputs.gemini_high }}
      should_run_fix: ${{ steps.decision.outputs.should_run }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup pnpm
        if: inputs.package_manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ inputs.pnpm_version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}

      - name: Install dependencies
        run: |
          if [ "${{ inputs.package_manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ inputs.package_manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi
        continue-on-error: true

      - name: Detect Issues
        id: detect
        continue-on-error: true
        run: |
          PKG_MGR="${{ inputs.package_manager }}"
          RUN_CMD="$PKG_MGR run"

          echo "ðŸ” å•é¡Œã‚’æ¤œå‡ºä¸­..."

          # Lint check
          echo "## Lint Check" > lint.log
          if ! $RUN_CMD ${{ inputs.lint_command }} >> lint.log 2>&1; then
            echo "lint_errors=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Lint errors detected"
          fi

          # Format check
          if grep -q '"${{ inputs.format_command }}"' package.json 2>/dev/null || \
             grep -q "'${{ inputs.format_command }}'" package.json 2>/dev/null; then
            echo "## Format Check" > format.log
            if ! $RUN_CMD ${{ inputs.format_command }}:check >> format.log 2>&1; then
              echo "format_errors=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ Format errors detected"
            fi
          fi

          # TypeScript check
          if grep -q '"${{ inputs.type_check_command }}"' package.json 2>/dev/null; then
            echo "## TypeScript Check" > ts.log
            if ! $RUN_CMD ${{ inputs.type_check_command }} >> ts.log 2>&1; then
              echo "ts_errors=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ TypeScript errors detected"
            fi
          fi

          # Build check
          echo "## Build Check" > build.log
          if ! $RUN_CMD ${{ inputs.build_command }} >> build.log 2>&1; then
            echo "build_errors=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Build errors detected"
          fi

          # Test check
          if grep -q '"${{ inputs.test_command }}"' package.json 2>/dev/null; then
            echo "## Test Check" > test.log
            if ! $RUN_CMD ${{ inputs.test_command }} >> test.log 2>&1; then
              echo "test_failures=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ Test failures detected"
            fi
          fi

          # Conflict check
          echo "## Conflict Check" > conflict.log
          git fetch origin ${{ github.base_ref }} || true
          BASE_SHA=$(git merge-base HEAD origin/${{ github.base_ref }} 2>/dev/null || echo "")
          if [ -n "$BASE_SHA" ]; then
            if git merge-tree $BASE_SHA HEAD origin/${{ github.base_ref }} 2>/dev/null | grep -q '<<<<<<<'; then
              echo "conflicts=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ Merge conflicts detected"
            fi
          fi

      - name: Check Gemini Review Priority
        id: gemini-check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const reviews = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              const geminiReview = reviews.data.find(r =>
                r.user.login.toLowerCase().includes('gemini') ||
                r.body.toLowerCase().includes('gemini')
              );

              if (geminiReview) {
                console.log('âœ… Gemini review found');
                if (/priority:?\s*high/i.test(geminiReview.body) ||
                    /ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«|critical/i.test(geminiReview.body) ||
                    /é«˜å„ªå…ˆåº¦|é«˜å„ªå…ˆ/i.test(geminiReview.body)) {
                  core.setOutput('gemini_high', 'true');
                  console.log('ðŸ”´ High priority issues found');
                }
                const fs = require('fs');
                fs.writeFileSync('gemini_review.txt', geminiReview.body);
              }
            } catch (error) {
              console.log('â„¹ï¸ No reviews yet:', error.message);
            }

      - name: Decide if fix is needed
        id: decision
        run: |
          if [ "${{ steps.detect.outputs.lint_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.format_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.ts_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.build_errors }}" = "true" ] || \
             [ "${{ steps.detect.outputs.test_failures }}" = "true" ] || \
             [ "${{ steps.detect.outputs.conflicts }}" = "true" ] || \
             [ "${{ steps.gemini-check.outputs.gemini_high }}" = "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "ðŸ¤– è‡ªå‹•ä¿®æ­£ãŒå¿…è¦ã§ã™"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "âœ… å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Upload Logs
        if: steps.decision.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: issue-logs
          path: |
            lint.log
            format.log
            ts.log
            build.log
            test.log
            conflict.log
            gemini_review.txt
          retention-days: 7

  auto-fix-simple:
    name: ç°¡å˜ãªä¿®æ­£
    needs: detect-issues
    if: |
      needs.detect-issues.outputs.should_run_fix == 'true' &&
      (needs.detect-issues.outputs.has_lint_errors == 'true' ||
       needs.detect-issues.outputs.has_format_errors == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        if: inputs.package_manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ inputs.pnpm_version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}

      - name: Install dependencies
        run: |
          if [ "${{ inputs.package_manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ inputs.package_manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      - name: Auto-fix
        run: |
          PKG_MGR="${{ inputs.package_manager }}"
          RUN_CMD="$PKG_MGR run"

          echo "ðŸ”§ è‡ªå‹•ä¿®æ­£ä¸­..."
          $RUN_CMD ${{ inputs.lint_fix_command }} || true

          if grep -q '"${{ inputs.format_command }}"' package.json 2>/dev/null; then
            $RUN_CMD ${{ inputs.format_command }} || true
          fi

      - name: Commit fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ðŸ¤– Auto-fix: Lint and format corrections"
            git push
            echo "âœ… Fixes committed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

  ai-fix:
    name: AIä¿®æ­£
    needs: [detect-issues, auto-fix-simple]
    if: |
      always() &&
      needs.detect-issues.outputs.should_run_fix == 'true' &&
      (needs.detect-issues.outputs.has_ts_errors == 'true' ||
       needs.detect-issues.outputs.has_build_errors == 'true' ||
       needs.detect-issues.outputs.has_test_failures == 'true' ||
       needs.detect-issues.outputs.gemini_high_priority == 'true')
    runs-on: ubuntu-latest
    outputs:
      fixes_applied: ${{ steps.apply-fixes.outputs.fixes_applied }}

    steps:
      - name: Check API Keys
        id: check-key
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -n "$GOOGLE_API_KEY" ]; then
            echo "âœ… GOOGLE_API_KEY found - using Gemini"
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "provider=gemini" >> $GITHUB_OUTPUT
          elif [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "âœ… ANTHROPIC_API_KEY found - using Claude"
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "provider=claude" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No API key found, skipping AI analysis"
            echo "has_key=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout PR branch
        if: steps.check-key.outputs.has_key == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        if: steps.check-key.outputs.has_key == 'true' && inputs.package_manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ inputs.pnpm_version }}

      - name: Setup Node.js
        if: steps.check-key.outputs.has_key == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}

      - name: Install dependencies
        if: steps.check-key.outputs.has_key == 'true'
        run: |
          if [ "${{ inputs.package_manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ inputs.package_manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      - name: Download Logs
        if: steps.check-key.outputs.has_key == 'true'
        uses: actions/download-artifact@v4
        with:
          name: issue-logs
        continue-on-error: true

      - name: Prepare Context
        if: steps.check-key.outputs.has_key == 'true'
        run: |
          git fetch origin ${{ github.base_ref }} || true
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt 2>/dev/null || echo "" > pr_diff.txt
          cat package.json | jq '{name, version, dependencies, devDependencies, scripts}' > package_info.json 2>/dev/null || echo "{}" > package_info.json

      - name: AI Analysis with Gemini
        if: steps.check-key.outputs.has_key == 'true' && steps.check-key.outputs.provider == 'gemini'
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          LANG="${{ inputs.language }}"
          if [ "$LANG" = "ja" ]; then
            SYSTEM_MSG="ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: ${{ inputs.tech_stack }}ã€‚CI/CDãƒ†ã‚¹ãƒˆåˆæ ¼ã‚’æœ€å„ªå…ˆã«ã€å•é¡Œã‚’åˆ†æžãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
          else
            SYSTEM_MSG="You are an experienced full-stack engineer. Tech stack: ${{ inputs.tech_stack }}. Prioritize CI/CD test passing and analyze/fix issues."
          fi

          # Helper function to sanitize log content
          # - Removes ANSI escape sequences (color codes, cursor control)
          # - Removes control characters (U+0000-U+001F except LF and TAB)
          # Usage: sanitize_log filename OR command | sanitize_log
          sanitize_log() {
            if [ -n "$1" ]; then
              cat "$1" 2>/dev/null || echo 'None'
            else
              cat
            fi | sed -E 's/\x1B\[[0-9;]*[a-zA-Z]//g' \
               | tr -d '\000-\010\013-\037'
          }

          CONTENT="$SYSTEM_MSG\n\nä»¥ä¸‹ã®å•é¡Œã‚’åˆ†æžã—ã€JSONå½¢å¼ã§ä¿®æ­£è¨ˆç”»ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚\n\n"
          CONTENT+="# Project\n\`\`\`json\n$(sanitize_log package_info.json)\n\`\`\`\n\n"
          CONTENT+="# Lint\n\`\`\`\n$(sanitize_log lint.log)\n\`\`\`\n\n"
          CONTENT+="# TypeScript\n\`\`\`\n$(sanitize_log ts.log)\n\`\`\`\n\n"
          CONTENT+="# Build\n\`\`\`\n$(sanitize_log build.log)\n\`\`\`\n\n"
          CONTENT+="# Test\n\`\`\`\n$(sanitize_log test.log)\n\`\`\`\n\n"
          CONTENT+="# Gemini Review\n$(sanitize_log gemini_review.txt)\n\n"
          CONTENT+="# Diff\n\`\`\`diff\n$(head -500 pr_diff.txt | sanitize_log)\n\`\`\`\n\n"
          CONTENT+='JSONå½¢å¼: {"should_fix_now":bool,"fixes":[{"file":"path","action":"modify","content":"full content","reason":"why"}],"summary_ja":"summary"}'

          # Escape for JSON using Python (handles all remaining special characters)
          ESCAPED_CONTENT=$(printf '%s' "$CONTENT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          cat > request.json << EOF
          {
            "contents": [{"parts": [{"text": $ESCAPED_CONTENT}]}],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 16000
            }
          }
          EOF

          curl -s "https://generativelanguage.googleapis.com/v1/models/${{ inputs.gemini_model }}:generateContent?key=$GOOGLE_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json > response.json

          cat response.json | jq -r '.candidates[0].content.parts[0].text // empty' > response_text.txt

          if [ ! -s response_text.txt ]; then
            echo '{"should_fix_now":false,"fixes":[],"summary_ja":"AIå¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"}' > fix_plan.json
          elif grep -q '```json' response_text.txt; then
            sed -n '/```json/,/```/p' response_text.txt | sed '1d;$d' > fix_plan.json
          elif grep -q '```' response_text.txt; then
            sed -n '/```/,/```/p' response_text.txt | sed '1d;$d' > fix_plan.json
          else
            cat response_text.txt > fix_plan.json
          fi

          echo "gemini" > ai_provider.txt

      - name: AI Analysis with Claude
        if: steps.check-key.outputs.has_key == 'true' && steps.check-key.outputs.provider == 'claude'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          LANG="${{ inputs.language }}"
          if [ "$LANG" = "ja" ]; then
            SYSTEM_MSG="ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: ${{ inputs.tech_stack }}ã€‚CI/CDãƒ†ã‚¹ãƒˆåˆæ ¼ã‚’æœ€å„ªå…ˆã«ã€å•é¡Œã‚’åˆ†æžãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
          else
            SYSTEM_MSG="You are an experienced full-stack engineer. Tech stack: ${{ inputs.tech_stack }}. Prioritize CI/CD test passing and analyze/fix issues."
          fi

          # Helper function to sanitize log content
          # - Removes ANSI escape sequences (color codes, cursor control)
          # - Removes control characters (U+0000-U+001F except LF and TAB)
          # Usage: sanitize_log filename OR command | sanitize_log
          sanitize_log() {
            if [ -n "$1" ]; then
              cat "$1" 2>/dev/null || echo 'None'
            else
              cat
            fi | sed -E 's/\x1B\[[0-9;]*[a-zA-Z]//g' \
               | tr -d '\000-\010\013-\037'
          }

          CONTENT="ä»¥ä¸‹ã®å•é¡Œã‚’åˆ†æžã—ã€JSONå½¢å¼ã§ä¿®æ­£è¨ˆç”»ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚\n\n"
          CONTENT+="# Project\n\`\`\`json\n$(sanitize_log package_info.json)\n\`\`\`\n\n"
          CONTENT+="# Lint\n\`\`\`\n$(sanitize_log lint.log)\n\`\`\`\n\n"
          CONTENT+="# TypeScript\n\`\`\`\n$(sanitize_log ts.log)\n\`\`\`\n\n"
          CONTENT+="# Build\n\`\`\`\n$(sanitize_log build.log)\n\`\`\`\n\n"
          CONTENT+="# Test\n\`\`\`\n$(sanitize_log test.log)\n\`\`\`\n\n"
          CONTENT+="# Gemini Review\n$(sanitize_log gemini_review.txt)\n\n"
          CONTENT+="# Diff\n\`\`\`diff\n$(head -500 pr_diff.txt | sanitize_log)\n\`\`\`\n\n"
          CONTENT+='JSONå½¢å¼: {"should_fix_now":bool,"fixes":[{"file":"path","action":"modify","content":"full content","reason":"why"}],"summary_ja":"summary"}'

          # Escape for JSON using Python (handles all remaining special characters)
          ESCAPED_CONTENT=$(printf '%s' "$CONTENT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          ESCAPED_SYSTEM=$(printf '%s' "$SYSTEM_MSG" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          cat > request.json << EOF
          {
            "model": "${{ inputs.claude_model }}",
            "max_tokens": 16000,
            "system": $ESCAPED_SYSTEM,
            "messages": [{"role": "user", "content": $ESCAPED_CONTENT}]
          }
          EOF

          curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @request.json > response.json

          cat response.json | jq -r '.content[0].text // empty' > response_text.txt

          if [ ! -s response_text.txt ]; then
            echo '{"should_fix_now":false,"fixes":[],"summary_ja":"AIå¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"}' > fix_plan.json
          elif grep -q '```json' response_text.txt; then
            sed -n '/```json/,/```/p' response_text.txt | sed '1d;$d' > fix_plan.json
          else
            cat response_text.txt > fix_plan.json
          fi

          echo "claude" > ai_provider.txt

      - name: Apply Fixes
        if: steps.check-key.outputs.has_key == 'true'
        id: apply-fixes
        env:
          AI_PROVIDER: ${{ steps.check-key.outputs.provider }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let plan;
            try {
              const parsed = JSON.parse(fs.readFileSync('fix_plan.json', 'utf8'));
              // Normalize structure: Gemini may return nested fix_plan
              plan = parsed.fix_plan || parsed;
            } catch (e) {
              console.log('Failed to parse plan:', e);
              return;
            }

            const provider = process.env.AI_PROVIDER || 'unknown';
            const providerName = provider === 'gemini' ? 'Gemini 2.0 Flash' : 'Claude Sonnet 4';

            // Support both should_fix_now and should_fix keys
            const shouldFix = plan.should_fix_now ?? plan.should_fix;
            console.log('ðŸ“‹ Should fix:', shouldFix);
            console.log('ðŸ“‹ Fixes count:', plan.fixes?.length || 0);

            let applied = [];
            if (shouldFix && plan.fixes) {
              for (const fix of plan.fixes) {
                try {
                  const dir = path.dirname(fix.file);
                  if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });

                  if (fix.action === 'delete') {
                    if (fs.existsSync(fix.file)) fs.unlinkSync(fix.file);
                  } else {
                    fs.writeFileSync(fix.file, fix.content, 'utf8');
                  }
                  applied.push(`âœ… ${fix.file}: ${fix.reason}`);
                } catch (e) {
                  applied.push(`âŒ ${fix.file}: ${e.message}`);
                }
              }
            }

            // Support both summary_ja and summary keys
            const summary = plan.summary_ja || plan.summary || 'N/A';
            const body = `## ðŸ¤– AI Auto-Fix Report\n\n### ä¿®æ­£å†…å®¹\n${applied.length > 0 ? applied.join('\n') : 'ä¿®æ­£ãªã—'}\n\n### è¦ç´„\n${summary}\n\n---\n_Powered by ${providerName}_`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

            core.setOutput('fixes_applied', applied.length > 0);

      - name: Commit AI Fixes
        if: steps.check-key.outputs.has_key == 'true' && steps.apply-fixes.outputs.fixes_applied == 'true'
        env:
          AI_PROVIDER: ${{ steps.check-key.outputs.provider }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          PROVIDER="${AI_PROVIDER:-AI}"
          PROVIDER_NAME=$(echo "$PROVIDER" | sed 's/gemini/Gemini/; s/claude/Claude/')

          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ðŸ¤– AI Fix: Resolve issues with $PROVIDER_NAME"
            git push
          fi
